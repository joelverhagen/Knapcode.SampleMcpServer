name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    permissions:
      id-token: write
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x
          global-json-file: "./global.json"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release

      - name: Pack
        run: dotnet pack --configuration Release -o ./artifacts /p:OutputServerJsonPath=./artifacts/server.json

      - name: NuGet login (OIDC â†’ temp API key)
        uses: NuGet/login@v1
        id: login
        with:
          user: joelverhagen

      - name: NuGet push
        run: dotnet nuget push artifacts/*.nupkg --api-key ${{steps.login.outputs.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json

      - name: Clone MCP Registry and build publisher tool
        shell: pwsh
        run: |
          cd ${{ runner.temp }}

          # Install Microsoft Go
          # This go-install.ps1 script could be checked into your source repository
          Invoke-WebRequest `
              https://raw.githubusercontent.com/microsoft/go-infra/refs/heads/main/goinstallscript/powershell/go-install.ps1 `
              -OutFile go-install.ps1
          ./go-install.ps1

          # Enable compliant crypto
          $env:GOEXPERIMENT = "systemcrypto"

          # Clone and build the publisher tool
          git clone --branch "v1.3.7" https://github.com/modelcontextprotocol/registry
          cd registry
          go build -o ${{ runner.temp }}/mcp-publisher.exe ./cmd/publisher

          # show help for the tool to ensure it's working
          ${{ runner.temp }}/mcp-publisher.exe --help

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.KV_CLIENT_ID }}
          tenant-id: ${{ secrets.KV_TENANT_ID }}
          subscription-id: ${{ secrets.KV_SUBSCRIPTION_ID }}

      - name: Wait for the NuGet package to be available
        shell: pwsh
        run: |
          $packageId = "Knapcode.SampleMcpServer"
          $packageFile = Get-ChildItem -Path ./artifacts -Filter "*.nupkg" | Sort-Object { $_.Name.Length } | Select-Object -First 1
          $packageFile = $packageFile.Name
          $version = $packageFile.Substring($packageId.Length + 1, $packageFile.Length - $packageId.Length - 1 - ".nupkg".Length)
          "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV
          
          $url = "https://api.nuget.org/v3-flatcontainer/$($packageId.ToLowerInvariant())/$($version.ToLowerInvariant())/readme"
          $elapsed = 0; $interval = 10; $timeout = 300
          Write-Host "Checking for package README of $packageId $version."
          while ($true) {
              if ($elapsed -gt $timeout) {
                  Write-Error "Package README is not available after $elapsed seconds. URL: $url"
                  exit 1
              }
              try { 
                  Invoke-WebRequest -Uri $url -ErrorAction Stop | Out-Null
                  Write-Host "Package README is now available."
                  break
              } catch {
                  Write-Host "Package README is not yet available. Elapsed time: $elapsed seconds."
                  Start-Sleep -Seconds $interval; $elapsed += $interval
                  continue
              }
          }

      - name: Publish to the MCP Registry
        shell: pwsh
        run: |
          # log in using Key Vault
          $env:AZURE_TOKEN_CREDENTIALS = "AzureCLICredential"
          ${{ runner.temp }}/mcp-publisher.exe `
              login dns azure-key-vault `
              -vault "${{ secrets.KV_NAME }}" -key "${{ secrets.KV_KEY_NAME }}" `
              -domain MCP.joelverhagen.com `
              -registry https://staging.registry.modelcontextprotocol.io
      
          # publish the server.json
          ${{ runner.temp }}/mcp-publisher.exe publish `
              "./artifacts/server.json" `
              -registry https://staging.registry.modelcontextprotocol.io
